<script defer>

function findProductSchemaScript() {
    var scriptElements = document.querySelectorAll('script[type="application/ld+json"]');
    return scriptElements[0];
}
/*
function findAggregateReviewsSchemaScript() {
    var scriptElements = document.querySelectorAll('script[type="application/ld+json"]');
    return scriptElements[scriptElements.length-1];
}*/

function handleReviewScript() {
    reviewsArray = addReviews();

    var productSchemaScript = findProductSchemaScript();
    var schemaData = JSON.parse(productSchemaScript.textContent);
    schemaData.review = reviewsArray;

    //var AggregateRating = findAggregateReviewsSchemaScript();
    //AggregateRatingJSON = JSON.parse(AggregateRating.textContent);
    var reviewsContent = document.querySelector('.reviews-num').textContent;
    var matches = reviewsContent.match(/\d+/);
    //var numberValue = matches ? parseInt(matches[0]) : null;

    schemaData.aggregateRating = [{
        "@type": "AggregateRating",
        "ratingValue": document.querySelector('.big-point').textContent,
        "bestRating": "5",
        "worstRating": "1",
        "ratingCount": matches[0]
    }];
    
    productSchemaScript.textContent = JSON.stringify(schemaData, null, 2);
    console.log(productSchemaScript.outerHTML);
    //AggregateRating.remove();
    
}

function addReviews(){
    var reviewsArray = [];
    var reviews = Array.from(document.getElementsByClassName('list-review'));
    for(i = 0; i < reviews.length; i++){
        //var reviewTitle = reviews[i].querySelector('.spr-review-header-title').innerHTML;
        var name = reviews[i].querySelector('.author-name').innerHTML;
        //var date =  reviews[i].querySelector('.spr-review-header-byline').querySelectorAll('strong')[1].innerHTML;
        
        /*var inputDate = new Date(date);
        var year = inputDate.getFullYear();
        var month = inputDate.getMonth() + 1; // Note: Months are zero-indexed
        var day = inputDate.getDate();
        var formattedDate = year + "-" + (month < 10 ? "0" : "") + month + "-" + (day < 10 ? "0" : "") + day;
        */
        
        var description = reviews[i].querySelector('.reviews-text').innerHTML;
        console.log(reviews[i].querySelector('.reviews-text'));
        var starRating = parseInt(document.getElementsByClassName('big-point')[0].innerHTML);

        reviewsArray.push({
            "@type": "Review",
            "name": name,
            "reviewBody": description,
            "author": {
                "@type": "Person",
                "name": name
            },
            "name": name,
            "datePublished": "2024-01-08",
            "reviewRating": {
                "@type": "Rating",
                "ratingValue": starRating
            },
            "publisher": {
                "@type": "Organization",
                "name": "Shopify Product Reviews"
            }
        });
        
    }
    return reviewsArray;
}

// Add event listener for DOMContentLoaded
window.addEventListener("DOMContentLoaded", function(){
    // Select the target element
    var targetElement = document.querySelector('.reviews-text');
    
    // Check if the target element exists before observing
    if (targetElement) {
        // Create a MutationObserver instance
        var observer = new MutationObserver(function(mutationsList, observer) {
            handleContentChange(mutationsList, observer, targetElement);
        });
        
        // Options for the observer (we want to observe changes to child nodes)
        var observerOptions = { childList: true };
        
        // Start observing the target element
        observer.observe(targetElement, observerOptions);
    } else {
        console.error("Target element not found");
    }
});

// Define handleContentChange function
function handleContentChange(mutationsList, observer, targetElement) {
    for(var mutation of mutationsList) {
        if (mutation.type === 'childList' && targetElement.innerHTML.trim() !== '') {
            // Content added to .reviews-text, execute your code here
            console.log('Content added to .reviews-text:', targetElement.innerHTML);
            handleReviewScript();
            observer.disconnect();
            break; // Exit the loop since the condition is met
        }
    }
}







</script>